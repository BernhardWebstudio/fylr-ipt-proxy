{% extends 'base.html.twig' %}

{% block title %}{{ 'export.title'|trans }}
{% endblock %}

{% block stylesheets %}
	<style>
		.table-responsive-stack tr > td:before {
			content: attr(data-label) ": ";
			font-weight: bold;
			display: none;
		}

		@media(max-width: 768px) {
			.table-responsive-stack table,
			.table-responsive-stack thead,
			.table-responsive-stack tbody,
			.table-responsive-stack th,
			.table-responsive-stack td,
			.table-responsive-stack tr {
				display: block;
			}

			.table-responsive-stack thead tr {
				position: absolute;
				top: -9999px;
				left: -9999px;
			}

			.table-responsive-stack tr {
				border: 1px solid #ccc;
				margin-bottom: 10px;
				padding: 10px;
				border-radius: 6px;
			}

			.table-responsive-stack td {
				border: none;
				position: relative;
				padding-left: 50%;
			}

			.table-responsive-stack tr > td:before {
				display: block;
				position: absolute;
				left: 6px;
				width: 45%;
				padding-right: 10px;
				white-space: nowrap;
			}
		}

		.form-row-inline {
			display: flex;
			flex-wrap: wrap;
			gap: 1rem;
			align-items: start;
		}

		.form-row-inline .form-group {
			flex: 1;
			min-width: 200px;
		}

		.form-row-inline .btn {
			margin-top: 0;
		}

		@media(max-width: 768px) {
			.form-row-inline {
				flex-direction: column;
				gap: 0.5rem;
			}

			.form-row-inline .form-group {
				min-width: 100%;
			}
		}
	</style>
{% endblock %}

{% block body %}
	<div class="container-fluid">
		<div class="row">
			<div class="col-12">
				<div class="content">
					<h1 class="content-title">
						<i class="fa fa-upload" aria-hidden="true"></i>
						{{ 'export.heading'|trans }}
					</h1>
					<p class="text-muted">
						{{ 'export.description'|trans }}
					</p>

					<!-- Export Form -->
					<div class="card">
						<div class="card-header">
							<h5 class="card-title">
								<i class="fa fa-filter" aria-hidden="true"></i>
								{{ 'export.filter_options'|trans }}
							</h5>
						</div>
						<div class="card-body">
							{{ form_start(form, {'attr': {'class': 'needs-validation', 'novalidate': true, 'data-turbo': 'false'}}) }}

							<div class="form-row-inline">
								<div class="form-group">
									{{ form_label(form.globalObjectId) }}
									{{ form_widget(form.globalObjectId, {'attr': {'class': 'form-control'}}) }}
									{% if form.globalObjectId.vars.help %}
										<small class="form-text text-muted">{{ form.globalObjectId.vars.help }}</small>
									{% endif %}
									{{ form_errors(form.globalObjectId) }}
								</div>

								<div class="form-group">
									{{ form_label(form.tagId) }}
									{{ form_widget(form.tagId, {'attr': {'class': 'form-control'}}) }}
									<small class="form-text text-muted">
										{{ 'export.select_tag_help'|trans }}
									</small>
									{{ form_errors(form.tagId) }}
								</div>

								<div class="form-group">
									{{ form_label(form.objectType) }}
									{{ form_widget(form.objectType, {'attr': {'class': 'form-control'}}) }}
									<small class="form-text text-muted">
										{{ 'export.limit_type_help'|trans }}
									</small>
									{{ form_errors(form.objectType) }}
								</div>

								<div class="form-group">
									{{ form_label(form.exportFormat) }}
									{{ form_widget(form.exportFormat, {'attr': {'class': 'form-control'}}) }}
									{{ form_errors(form.exportFormat) }}
								</div>

								<div class="form-group">
									<label>{{ 'label.actions'|trans }}</label><br/>
									<div class="btn-group" role="group" aria-label="{{ 'label.actions'|trans }}">
										{{ form_widget(form.preview, {'attr': {'class': 'btn btn-primary'}}) }}
										{{ form_widget(form.export, {'attr': {'class': 'btn btn-success'}}) }}
									</div>
								</div>
							</div>

							{{ form_end(form) }}
						</div>
					</div>

					<!-- Preview Results Table (shared with import) -->
					{% include 'import_export_management/_results_table.html.twig' with {
						previewEntities: previewEntities,
						tableColumns: tableColumns,
						tableConfigService: tableConfigService,
						currentPage: currentPage,
						nEntriesPerPage: nEntriesPerPage,
						hasMore: hasMore,
						routeName: 'app_export_management',
						showImportAction: false
					} %}

					<!-- Empty States -->
					{% if (previewEntities is not defined or previewEntities|length == 0) %}
						{% if isSubmitted and hasSearchCriteria %}
							{% include 'import_export_management/_empty_state.html.twig' with {
								type: 'no_results',
								context: 'export',
								hasSearchCriteria: hasSearchCriteria
							} %}
						{% else %}
							{% include 'import_export_management/_empty_state.html.twig' with {
								type: 'ready',
								context: 'export'
							} %}
						{% endif %}
					{% endif %}
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block body_javascripts %}
	<script>
		// Initialize tooltips
		document.addEventListener('DOMContentLoaded', function () {
			var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
			tooltipTriggerList.map(function (tooltipTriggerEl) {
				return new bootstrap.Tooltip(tooltipTriggerEl);
			});
		});

		// Form validation feedback
		(function () {
			'use strict';
			window.addEventListener('load', function () {
				var forms = document.getElementsByClassName('needs-validation');
				var validation = Array.prototype.filter.call(forms, function (form) {
					form.addEventListener('submit', function (event) {
						if (form.checkValidity() === false) {
							event.preventDefault();
							event.stopPropagation();
						}
						form.classList.add('was-validated');
					}, false);
				});
			}, false);
		})();
	</script>
{% endblock %}
